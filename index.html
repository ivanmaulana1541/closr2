<!DOCTYPE html>
<html>
<head>

<meta charset="UTF-8">
<title>closr2 ‚Äî social radar</title>

<link rel="stylesheet"
href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<style>

body{
margin:0;
font-family:Arial;
background:#eef1f7;
}

header{
background:#4a6cff;
color:white;
padding:12px;
text-align:center;
font-size:18px;
}

#map{
height:90vh;
}

.centerBtn{
position:absolute;
bottom:20px;
right:15px;
background:#4a6cff;
color:white;
border:none;
padding:12px;
border-radius:50%;
font-size:18px;
box-shadow:0 4px 10px rgba(0,0,0,.2);
cursor:pointer;
}

.pick{
width:60px;
margin:5px;
cursor:pointer;
border-radius:50%;
border:3px solid transparent;
}

.pick:hover{
border-color:#4a6cff;
}  

</style>

</head>

<body>

<header>üìç closr2 ‚Äî social radar</header>

<div id="map"></div>
  <div id="avatarPicker" style="
position:absolute;
top:60px;
left:50%;
transform:translateX(-50%);
background:white;
padding:10px;
border-radius:10px;
box-shadow:0 4px 10px rgba(0,0,0,.2);
display:none;
z-index:999;
">

<b>Pilih avatar:</b><br><br>

<img src="avatar/avatar1.png" class="pick">
<img src="avatar/avatar2.png" class="pick">
<img src="avatar/avatar3.png" class="pick">
<img src="avatar/avatar4.png" class="pick">

</div>

<button class="centerBtn" onclick="centerMe()">üéØ</button>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script type="module">

//////////////////////////////////////////////////////
// FIREBASE IMPORT
//////////////////////////////////////////////////////

import { initializeApp }
from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";

import {
getAuth,
signInAnonymously,
onAuthStateChanged
}
from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";

import {
getDatabase,
ref,
set,
update,
onValue
}
from "https://www.gstatic.com/firebasejs/12.9.0/firebase-database.js";

//////////////////////////////////////////////////////
// FIREBASE CONFIG
//////////////////////////////////////////////////////

const firebaseConfig = {
apiKey:"AIzaSyD9SIzJ58zYVlvwGYewKXwCmrq6SGgDLUM",
authDomain:"closr-c35df.firebaseapp.com",
databaseURL:"https://closr-c35df-default-rtdb.firebaseio.com",
projectId:"closr-c35df",
storageBucket:"closr-c35df.firebasestorage.app",
messagingSenderId:"352431132160",
appId:"1:352431132160:web:6125a40a3853d1fd6592e5"
};

//////////////////////////////////////////////////////
// INIT FIREBASE
//////////////////////////////////////////////////////

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);

signInAnonymously(auth);

//////////////////////////////////////////////////////
// MAP INIT ‚Äî CARTO
//////////////////////////////////////////////////////

let map=L.map("map").setView([-6.2,106.8],15);

L.tileLayer(
"https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png",
{attribution:"¬© CARTO"}
).addTo(map);

//////////////////////////////////////////////////////
// AVATAR ICON
//////////////////////////////////////////////////////

function makeAvatar(url){

return L.divIcon({
className:"",
html:`
<img src="${url}"
style="
width:60px;
height:60px;
border-radius:50%;
border:3px solid #ff7b00;">
`
});

}

//////////////////////////////////////////////////////
// USER PROFILE INIT
//////////////////////////////////////////////////////

function ensureUserProfile(uid){

onValue(ref(db,"users/"+uid+"/avatar"),snap=>{

if(!snap.exists()){
showAvatarPicker(uid);
}

},{onlyOnce:true});

update(ref(db,"users/"+uid),{
username:"user_"+uid.slice(0,4)
});

}

function showAvatarPicker(uid){

let picker=document.getElementById("avatarPicker");
picker.style.display="block";

document.querySelectorAll(".pick").forEach(img=>{

img.onclick=()=>{

let avatar=img.getAttribute("src");

update(ref(db,"users/"+uid),{
avatar:avatar
});

picker.style.display="none";

};

});

}  

//////////////////////////////////////////////////////
// GPS + AUTO CENTER
//////////////////////////////////////////////////////

let myLat=null;
let myLng=null;

function centerMe(){

if(myLat && myLng){
map.flyTo([myLat,myLng],16);
}

}

function startGPS(uid){

navigator.geolocation.watchPosition(pos=>{

myLat=pos.coords.latitude;
myLng=pos.coords.longitude;

// auto follow
map.flyTo([myLat,myLng],16);

set(ref(db,"users/"+uid+"/lat"),myLat);
set(ref(db,"users/"+uid+"/lng"),myLng);

},
()=>{
alert("GPS gagal");
},
{enableHighAccuracy:true});

}

//////////////////////////////////////////////////////
// RADAR USER MARKERS
//////////////////////////////////////////////////////

let markers={};

onValue(ref(db,"users"),snap=>{

snap.forEach(c=>{

let u=c.val();
let id=c.key;

if(!u.lat || !u.lng) return;

let icon=makeAvatar(u.avatar || "avatar/avatar1.png");

if(markers[id]){

markers[id]
.setLatLng([u.lat,u.lng])
.setIcon(icon)
.bindPopup(`${u.username || "user"} online`);

}else{

markers[id]=L.marker(
[u.lat,u.lng],
{icon}
)
.addTo(map)
.bindPopup(`${u.username || "user"} online`);

}

});

});

//////////////////////////////////////////////////////
// AUTH READY
//////////////////////////////////////////////////////

onAuthStateChanged(auth,user=>{

if(!user) return;

let uid=user.uid;

ensureUserProfile(uid);
startGPS(uid);

});

//////////////////////////////////////////////////////
// EXPOSE BUTTON FUNC
//////////////////////////////////////////////////////

window.centerMe=centerMe;

</script>

</body>
</html>

<!DOCTYPE html>
<html>
<head>

<meta charset="UTF-8">
<title>closr ‚Äî social map ultimate</title>

<link rel="stylesheet"
href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<style>

body{margin:0;font-family:Arial;background:#eef1f7;}

header{
background:#4a6cff;
color:white;
padding:12px;
text-align:center;
}

#map{height:60vh;}

.card{
background:white;
padding:10px;
margin:10px;
border-radius:8px;
}

button{
padding:8px;
margin:4px;
background:#4a6cff;
color:white;
border:none;
border-radius:6px;
cursor:pointer;
}

input,textarea{
padding:8px;margin:4px;width:95%;
}

.popup{
position:absolute;
top:80px;
left:50%;
transform:translateX(-50%);
background:white;
padding:12px;
border-radius:10px;
box-shadow:0 4px 10px rgba(0,0,0,.2);
display:none;
z-index:999;
max-width:90%;
}

.timeline{
position:absolute;
bottom:0;
left:0;
right:0;
max-height:40%;
background:white;
overflow:auto;
padding:10px;
border-top:2px solid #ddd;
display:none;
z-index:998;
}

img.preview{
max-width:100%;
border-radius:8px;
margin-top:6px;
}

</style>
</head>

<body>

<header>üìç closr ‚Äî social map</header>

<div id="loginBox" class="card"></div>

<button onclick="openMoment()">üì∏ Share Moment</button>
<button onclick="toggleTimeline()">üì∞ Timeline</button>

<div id="map"></div>

<!-- moment popup -->
<div id="momentBox" class="popup">
<b>Share moment</b><br>
<textarea id="momentText"></textarea><br>
<input type="file" id="photo"><br>
<label>
<input type="checkbox" id="friendOnly">
Friends only
</label><br>
<button onclick="sendMoment()">Post</button>
<button onclick="momentBox.style.display='none'">Close</button>
</div>

<!-- profile popup -->
<div id="profileBox" class="popup"></div>

<div id="timeline" class="timeline"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script type="module">

//////////////////////// FIREBASE ////////////////////////

import { initializeApp }
from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";

import {
getAuth,
createUserWithEmailAndPassword,
signInWithEmailAndPassword,
signOut,
onAuthStateChanged
} from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";

import {
getDatabase,
ref,
update,
set,
push,
onValue
} from "https://www.gstatic.com/firebasejs/12.9.0/firebase-database.js";

const firebaseConfig={
apiKey:"AIzaSyD9SIzJ58zYVlvwGYewKXwCmrq6SGgDLUM",
authDomain:"closr-c35df.firebaseapp.com",
databaseURL:"https://closr-c35df-default-rtdb.firebaseio.com",
projectId:"closr-c35df",
storageBucket:"closr-c35df.firebasestorage.app",
messagingSenderId:"352431132160",
appId:"1:352431132160:web:6125a40a3853d1fd6592e5"
};

const appFirebase=initializeApp(firebaseConfig);
const auth=getAuth(appFirebase);
const db=getDatabase(appFirebase);

//////////////////////// MAP ////////////////////////

let map=L.map("map").setView([-6.2,106.8],15);

L.tileLayer(
"https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png"
).addTo(map);

let userMarkers={};
let momentMarkers={};

let myUID=null;
let myLat,myLng;

//////////////////////// LOGIN ////////////////////////

const loginBox=document.getElementById("loginBox");

function showLogin(){

loginBox.innerHTML=`
<h3>Login</h3>
<input id="email"><br>
<input id="pass" type="password"><br>
<button id="reg">Register</button>
<button id="log">Login</button>
`;

reg.onclick=()=>createUserWithEmailAndPassword(auth,email.value,pass.value)
.catch(e=>alert(e.message));

log.onclick=()=>signInWithEmailAndPassword(auth,email.value,pass.value)
.catch(e=>alert(e.message));
}

//////////////////////// GPS ////////////////////////

function startGPS(){

navigator.geolocation.watchPosition(pos=>{

myLat=pos.coords.latitude;
myLng=pos.coords.longitude;

update(ref(db,"users/"+myUID),{
lat:myLat,lng:myLng,status:"online"
});

map.setView([myLat,myLng],16);

});
}

//////////////////////// MOMENT ////////////////////////

window.openMoment=()=>{
momentBox.style.display="block";
};

window.sendMoment=()=>{

let text=momentText.value.trim();
if(!text) return;

let reader=new FileReader();

reader.onload=()=>{

push(ref(db,"moments/"+myUID),{
text,
photo:reader.result||"",
lat:myLat,
lng:myLng,
time:Date.now(),
friendsOnly:friendOnly.checked
});

};

if(photo.files[0]) reader.readAsDataURL(photo.files[0]);
else reader.onload();

momentText.value="";
photo.value="";
friendOnly.checked=false;
momentBox.style.display="none";

};

//////////////////////// RADAR ////////////////////////

onValue(ref(db,"users"),snap=>{

for(let id in userMarkers)
map.removeLayer(userMarkers[id]);

userMarkers={};

snap.forEach(c=>{

let u=c.val();
if(!u.lat) return;

let icon=L.divIcon({
className:"",
html:`<img src="${u.avatar||'avatar/avatar1.png'}"
style="width:50px;border-radius:50%;"><br>${u.username||"user"}`
});

let m=L.marker([u.lat,u.lng],{icon}).addTo(map);

m.on("click",()=>openProfile(c.key));

userMarkers[c.key]=m;

});

});

//////////////////////// MOMENT MARKERS ////////////////////////

onValue(ref(db,"moments"),snap=>{

for(let id in momentMarkers)
map.removeLayer(momentMarkers[id]);

momentMarkers={};

snap.forEach(userMoments=>{

userMoments.forEach(m=>{

let d=m.val();

if(d.friendsOnly && userMoments.key!==myUID) return;

let marker=L.marker([d.lat,d.lng])
.addTo(map)
.bindPopup(`
üìç ${d.text}
${d.photo?`<img class="preview" src="${d.photo}">`:""}
`);

momentMarkers[m.key]=marker;

});

});

});

//////////////////////// PROFILE ////////////////////////

function openProfile(uid){

onValue(ref(db,"moments/"+uid),snap=>{

let html="<b>Profile</b><br><br>";

snap.forEach(m=>{

let d=m.val();

html+=`
üìç ${d.text}<br>
${d.photo?`<img class="preview" src="${d.photo}">`:""}
<hr>
`;

});

html+=`<button onclick="profileBox.style.display='none'">Close</button>`;

profileBox.innerHTML=html;
profileBox.style.display="block";

},{onlyOnce:true});
}

//////////////////////// TIMELINE ////////////////////////

window.toggleTimeline=()=>{

timeline.style.display=
timeline.style.display==="none"?"block":"none";

};

function loadTimeline(){

onValue(ref(db,"moments"),snap=>{

let feed=[];

snap.forEach(userMoments=>{

userMoments.forEach(m=>{
feed.push(m.val());
});

});

feed.sort((a,b)=>b.time-a.time);

let html="<b>Timeline</b><br>";

feed.forEach(f=>{

html+=`
üìç ${f.text}<br>
${f.photo?`<img class="preview" src="${f.photo}">`:""}
<hr>
`;

});

timeline.innerHTML=html;

});
}

//////////////////////// AUTH ////////////////////////

onAuthStateChanged(auth,user=>{

if(user){

myUID=user.uid;

loginBox.innerHTML=`
Logged in<br>
<button id="logout">Logout</button>
`;

logout.onclick=()=>{
update(ref(db,"users/"+myUID),{status:"offline"});
signOut(auth);
};

startGPS();
loadTimeline();

}else showLogin();

});

</script>
</body>
</html>

<!DOCTYPE html>
<html>
<head>

<meta charset="UTF-8">
<title>closr2 ‚Äî social radar</title>

<link rel="stylesheet"
href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<style>

body{
margin:0;
font-family:Arial;
background:#eef1f7;
}

header{
background:#4a6cff;
color:white;
padding:12px;
text-align:center;
}

#map{
height:80vh;
}

.card{
background:white;
padding:10px;
}

input,button{
padding:8px;
margin:5px;
}

.usernameLabel{
background:white;
padding:2px 6px;
border-radius:6px;
font-size:12px;
}

</style>

</head>

<body>

<header>üìç closr2 ‚Äî social radar</header>

<div class="card" id="login"></div>
<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script type="module">

//////////////////////////////////////////////////////
// FIREBASE IMPORT
//////////////////////////////////////////////////////

import { initializeApp }
from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";

import {
getAuth,
createUserWithEmailAndPassword,
signInWithEmailAndPassword,
onAuthStateChanged
} from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";

import {
getDatabase,
ref,
set,
onValue
} from "https://www.gstatic.com/firebasejs/12.9.0/firebase-database.js";

//////////////////////////////////////////////////////
// FIREBASE CONFIG ‚Äî PUNYA KAMU
//////////////////////////////////////////////////////

const firebaseConfig={
apiKey:"AIzaSyD9SIzJ58zYVlvwGYewKXwCmrq6SGgDLUM",
authDomain:"closr-c35df.firebaseapp.com",
databaseURL:"https://closr-c35df-default-rtdb.firebaseio.com",
projectId:"closr-c35df",
storageBucket:"closr-c35df.firebasestorage.app",
messagingSenderId:"352431132160",
appId:"1:352431132160:web:6125a40a3853d1fd6592e5"
};

const appFirebase=initializeApp(firebaseConfig);
const auth=getAuth(appFirebase);
const db=getDatabase(appFirebase);

//////////////////////////////////////////////////////
// MAP INIT
//////////////////////////////////////////////////////

let map=L.map("map").setView([-6.2,106.8],15);

L.tileLayer(
"https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png",
{attribution:"¬© CARTO"}
).addTo(map);

//////////////////////////////////////////////////////
// LOGIN UI
//////////////////////////////////////////////////////

const loginBox=document.getElementById("login");

function showLogin(){

loginBox.innerHTML=`
<input id="email" placeholder="email">
<input id="pass" type="password" placeholder="password">
<input id="username" placeholder="username publik">
<button id="reg">Register</button>
<button id="log">Login</button>
`;

reg.onclick=()=>{

createUserWithEmailAndPassword(
auth,email.value,pass.value
).then(user=>{

set(ref(db,"users/"+user.user.uid),{
username:username.value,
avatar:"avatar/avatar1.png"
});

});

};

log.onclick=()=>{
signInWithEmailAndPassword(auth,email.value,pass.value);
};

}

//////////////////////////////////////////////////////
// USER MARKERS
//////////////////////////////////////////////////////

let markers={};

function makeIcon(username,avatar){

return L.divIcon({
className:"",
html:`
<div style="text-align:center;">
<img src="${avatar}"
style="width:40px;height:40px;border-radius:50%;">
<div class="usernameLabel">${username}</div>
</div>
`
});

}

function listenUsers(){

onValue(ref(db,"users"),snap=>{

for(let k in markers){
map.removeLayer(markers[k]);
}
markers={};

snap.forEach(c=>{

let u=c.val();

if(!u.lat) return;

markers[c.key]=L.marker(
[u.lat,u.lng],
{icon:makeIcon(u.username,u.avatar)}
).addTo(map);

});

});

}

//////////////////////////////////////////////////////
// GPS SYNC
//////////////////////////////////////////////////////

function startGPS(){

navigator.geolocation.watchPosition(pos=>{

let lat=pos.coords.latitude;
let lng=pos.coords.longitude;

set(ref(db,"users/"+auth.currentUser.uid),{
lat,lng,
username:"online",
avatar:"avatar/avatar1.png"
});

});

}

//////////////////////////////////////////////////////
// AUTH STATE
//////////////////////////////////////////////////////

onAuthStateChanged(auth,user=>{

if(user){

loginBox.innerHTML="Logged in ‚úî";
startGPS();
listenUsers();

}else{

showLogin();

}

});

</script>

</body>
</html>

<!DOCTYPE html>
<html>
<head>

<meta charset="UTF-8">
<title>closr2 ‚Äî social radar + tagged moments</title>

<link rel="stylesheet"
href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<style>

body{margin:0;font-family:Arial;background:#eef1f7;}

header{
background:#4a6cff;color:white;padding:12px;text-align:center;
}

#map{height:65vh;}

.card{
background:white;padding:10px;margin:10px;border-radius:8px;
}

button{
padding:8px;margin:4px;background:#4a6cff;
color:white;border:none;border-radius:6px;
}

input,textarea{
padding:8px;margin:4px;width:90%;
}

.popup{
position:absolute;top:90px;left:50%;
transform:translateX(-50%);
background:white;padding:12px;
border-radius:10px;
box-shadow:0 4px 10px rgba(0,0,0,.2);
display:none;z-index:999;
max-width:90%;
}

#placeResults div{
padding:4px;
cursor:pointer;
border-bottom:1px solid #eee;
}

</style>
</head>

<body>

<header>üìç closr2 ‚Äî social radar + tagged moments</header>

<div id="loginBox" class="card"></div>

<button onclick="openMoment()">üì∏ Share Moment</button>

<div id="map"></div>

<!-- MOMENT POPUP -->
<div id="momentBox" class="popup">

<b>Share moment:</b><br>
<textarea id="momentText"></textarea><br>

üìç Tag lokasi:<br>
<input id="placeSearch" placeholder="Cari cafe/resto‚Ä¶">
<div id="placeResults"></div>

<button onclick="sendMoment()">Post</button>
<button onclick="momentBox.style.display='none'">Close</button>

</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script type="module">

////////////////////////////////////////////////////////
// FIREBASE
////////////////////////////////////////////////////////

import { initializeApp }
from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";

import {
getAuth,
createUserWithEmailAndPassword,
signInWithEmailAndPassword,
signOut,
onAuthStateChanged
} from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";

import {
getDatabase,
ref,
update,
set,
remove,
push,
onValue
} from "https://www.gstatic.com/firebasejs/12.9.0/firebase-database.js";

const firebaseConfig={
apiKey:"AIzaSyD9SIzJ58zYVlvwGYewKXwCmrq6SGgDLUM",
authDomain:"closr-c35df.firebaseapp.com",
databaseURL:"https://closr-c35df-default-rtdb.firebaseio.com",
projectId:"closr-c35df"
};

const appFirebase=initializeApp(firebaseConfig);
const auth=getAuth(appFirebase);
const db=getDatabase(appFirebase);

////////////////////////////////////////////////////////
// MAP
////////////////////////////////////////////////////////

let map=L.map("map").setView([-6.2,106.8],15);

L.tileLayer(
"https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png"
).addTo(map);

let markers={};
let myUID=null;
let myLat,myLng;
let interactionPopup=null;

////////////////////////////////////////////////////////
// LOGIN UI
////////////////////////////////////////////////////////

const loginBox=document.getElementById("loginBox");

function showLogin(){

loginBox.innerHTML=`
<h3>Login</h3>
<input id="email"><br>
<input id="pass" type="password"><br>
<button id="reg">Register</button>
<button id="log">Login</button>
`;

reg.onclick=()=>{
createUserWithEmailAndPassword(auth,email.value,pass.value)
.catch(e=>alert(e.message));
};

log.onclick=()=>{
signInWithEmailAndPassword(auth,email.value,pass.value)
.catch(e=>alert(e.message));
};

}

////////////////////////////////////////////////////////
// GPS TRACK
////////////////////////////////////////////////////////

function startGPS(){

navigator.geolocation.watchPosition(pos=>{

myLat=pos.coords.latitude;
myLng=pos.coords.longitude;

update(ref(db,"users/"+myUID),{
lat:myLat,
lng:myLng,
status:"online"
});

map.setView([myLat,myLng],16);

});

}

////////////////////////////////////////////////////////
// MOMENT + LOCATION TAGGING
////////////////////////////////////////////////////////

let selectedPlace=null;

window.openMoment=()=>{
momentBox.style.display="block";
};

window.sendMoment=()=>{

let text=momentText.value.trim();
if(!text || !myUID) return;

let lat=myLat;
let lng=myLng;
let place="";

if(selectedPlace){
lat=selectedPlace.lat;
lng=selectedPlace.lng;
place=selectedPlace.name;
}

push(ref(db,"moments/"+myUID),{
text,
lat,
lng,
place,
time:Date.now()
});

momentText.value="";
placeSearch.value="";
selectedPlace=null;

momentBox.style.display="none";

};

placeSearch.oninput=async()=>{

let q=placeSearch.value.trim();

if(q.length<3){
placeResults.innerHTML="";
return;
}

let res=await fetch(
`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)}`
);

let data=await res.json();

placeResults.innerHTML="";

data.slice(0,5).forEach(p=>{

let div=document.createElement("div");
div.innerHTML="üìç "+p.display_name;

div.onclick=()=>{

selectedPlace={
name:p.display_name,
lat:parseFloat(p.lat),
lng:parseFloat(p.lon)
};

placeSearch.value=p.display_name;
placeResults.innerHTML="";

};

placeResults.appendChild(div);

});

};

////////////////////////////////////////////////////////
// FRIEND REQUEST
////////////////////////////////////////////////////////

function sendFriendRequest(targetUID){

if(targetUID===myUID) return;

set(ref(db,"friendRequests/"+targetUID+"/"+myUID),true);
alert("Friend request sent!");

}

function watchFriendRequests(){

onValue(ref(db,"friendRequests/"+myUID),snap=>{

if(!snap.exists()) return;

snap.forEach(req=>{

let from=req.key;

if(confirm("Friend request from "+from+" ?")){

update(ref(db,"friends/"+myUID+"/"+from),true);
update(ref(db,"friends/"+from+"/"+myUID),true);

remove(ref(db,"friendRequests/"+myUID+"/"+from));

}

});

});

}

////////////////////////////////////////////////////////
// USER RADAR
////////////////////////////////////////////////////////

function showInteraction(uid,name){

if(interactionPopup) interactionPopup.remove();

interactionPopup=document.createElement("div");
interactionPopup.className="popup";
interactionPopup.style.display="block";

interactionPopup.innerHTML=`
<b>${name}</b><br><br>
<button onclick="sendFriendRequest('${uid}')">Add Friend</button>
<button onclick="interactionPopup.remove()">Close</button>
`;

document.body.appendChild(interactionPopup);

}

window.sendFriendRequest=sendFriendRequest;

onValue(ref(db,"users"),snap=>{

for(let id in markers){
map.removeLayer(markers[id]);
}
markers={};

snap.forEach(c=>{

let u=c.val();
if(!u.lat) return;

let icon=L.divIcon({
className:"",
html:`
<img src="${u.avatar||'avatar/avatar1.png'}"
style="width:50px;height:50px;border-radius:50%;">
<br>${u.username||"user"}
`
});

let m=L.marker([u.lat,u.lng],{icon}).addTo(map);

m.on("click",()=>{
if(c.key!==myUID)
showInteraction(c.key,u.username||"user");
});

markers[c.key]=m;

});

});

////////////////////////////////////////////////////////
// TIMELINE
////////////////////////////////////////////////////////

const timelineBox=document.createElement("div");

timelineBox.style.cssText=`
position:absolute;bottom:0;left:0;right:0;
max-height:40%;background:white;
border-top:2px solid #ddd;
overflow:auto;padding:10px;display:none;
`;

document.body.appendChild(timelineBox);

function toggleTimeline(){

timelineBox.style.display=
timelineBox.style.display==="none"?"block":"none";

loadTimeline();

}

function loadTimeline(){

timelineBox.innerHTML="<b>Timeline</b><br><br>";

onValue(ref(db,"moments"),snap=>{

let feed=[];

snap.forEach(user=>{

user.forEach(m=>{
feed.push(m.val());
});

});

feed.sort((a,b)=>b.time-a.time);

feed.forEach(f=>{

timelineBox.innerHTML+=`
üìç ${f.text}<br>
${f.place?`<small>${f.place}</small><br>`:""}
<small>${new Date(f.time).toLocaleString()}</small>
<hr>
`;

});

},{onlyOnce:true});

}

////////////////////////////////////////////////////////
// AUTH
////////////////////////////////////////////////////////

onAuthStateChanged(auth,user=>{

if(user){

myUID=user.uid;

loginBox.innerHTML=`
Logged in: ${user.email}<br><br>
<button id="timelineBtn">Timeline</button>
<button id="logout">Logout</button>
`;

timelineBtn.onclick=toggleTimeline;

logout.onclick=()=>{
update(ref(db,"users/"+myUID),{status:"offline"});
signOut(auth);
};

watchFriendRequests();
startGPS();

}else{

showLogin();

}

});

</script>
</body>
</html>

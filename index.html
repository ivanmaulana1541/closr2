<!DOCTYPE html>
<html>
<head>

<meta charset="UTF-8">
<title>closr2 ‚Äî social radar + DM</title>

<link rel="stylesheet"
href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<style>

body{
margin:0;
font-family:Arial;
background:#eef1f7;
}

header{
background:#4a6cff;
color:white;
padding:12px;
text-align:center;
font-size:18px;
}

#map{
height:70vh;
}

.card{
background:white;
padding:10px;
margin:10px;
border-radius:8px;
}

button{
padding:8px;
margin:4px;
background:#4a6cff;
color:white;
border:none;
border-radius:6px;
cursor:pointer;
}

input{
padding:8px;
margin:4px;
width:90%;
}

.pick{
width:60px;
margin:5px;
cursor:pointer;
border-radius:50%;
border:3px solid transparent;
}

.pick:hover{
border-color:#4a6cff;
}

#avatarPicker,
#usernameBox,
#chatBox,
#userMenu{
position:absolute;
top:90px;
left:50%;
transform:translateX(-50%);
background:white;
padding:12px;
border-radius:10px;
box-shadow:0 4px 10px rgba(0,0,0,.2);
display:none;
z-index:999;
width:300px;
}

#chatMessages{
height:180px;
overflow:auto;
border:1px solid #ddd;
padding:6px;
margin-bottom:6px;
}

</style>

</head>

<body>

<header>üìç closr2 ‚Äî social radar + DM</header>

<div id="loginBox" class="card"></div>

<div id="map"></div>

<!-- USERNAME -->
<div id="usernameBox">
<b>Masukkan username:</b><br><br>
<input id="uname"><br>
<button id="saveU">Save</button>
</div>

<!-- AVATAR -->
<div id="avatarPicker">
<b>Pilih avatar:</b><br><br>
<img src="avatar/avatar1.png" class="pick">
<img src="avatar/avatar2.png" class="pick">
<img src="avatar/avatar3.png" class="pick">
<img src="avatar/avatar4.png" class="pick">
</div>

<!-- USER MENU -->
<div id="userMenu">
<b id="menuName"></b><br><br>
<button id="dmBtn">üí¨ DM</button>
<button onclick="alert('profile soon')">üë§ Profile</button>
<button onclick="alert('friend system next')">‚ûï Friend</button>
<br><br>
<button onclick="userMenu.style.display='none'">Close</button>
</div>

<!-- CHAT -->
<div id="chatBox">
<b id="chatTitle"></b><br><br>
<div id="chatMessages"></div>
<input id="chatInput" placeholder="ketik pesan">
<button id="sendBtn">Send</button>
<button onclick="chatBox.style.display='none'">Close</button>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script type="module">

////////////////////////////////////////////////////////
// FIREBASE
////////////////////////////////////////////////////////

import { initializeApp }
from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";

import {
getAuth,
createUserWithEmailAndPassword,
signInWithEmailAndPassword,
signOut,
onAuthStateChanged
} from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";

import {
getDatabase,
ref,
update,
push,
onValue
} from "https://www.gstatic.com/firebasejs/12.9.0/firebase-database.js";

const firebaseConfig={
apiKey:"AIzaSyD9SIzJ58zYVlvwGYewKXwCmrq6SGgDLUM",
authDomain:"closr-c35df.firebaseapp.com",
databaseURL:"https://closr-c35df-default-rtdb.firebaseio.com",
projectId:"closr-c35df"
};

const appFirebase=initializeApp(firebaseConfig);
const auth=getAuth(appFirebase);
const db=getDatabase(appFirebase);

////////////////////////////////////////////////////////
// MAP
////////////////////////////////////////////////////////

let map=L.map("map").setView([-6.2,106.8],15);

L.tileLayer(
"https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png"
).addTo(map);

let markers={};
let myUID=null;
let myLat,myLng;

////////////////////////////////////////////////////////
// LOGIN UI
////////////////////////////////////////////////////////

const loginBox=document.getElementById("loginBox");

function showLogin(){

loginBox.innerHTML=`
<h3>Login</h3>
<input id="email" placeholder="email"><br>
<input id="pass" type="password" placeholder="password"><br>
<button id="reg">Register</button>
<button id="log">Login</button>
`;

reg.onclick=()=>{
createUserWithEmailAndPassword(auth,email.value,pass.value)
.catch(e=>alert(e.message));
};

log.onclick=()=>{
signInWithEmailAndPassword(auth,email.value,pass.value)
.catch(e=>alert(e.message));
};

}

////////////////////////////////////////////////////////
// PROFILE SETUP
////////////////////////////////////////////////////////

function askUsername(uid){

usernameBox.style.display="block";

saveU.onclick=()=>{

let name=uname.value.trim();
if(!name) return;

update(ref(db,"users/"+uid),{username:name});
usernameBox.style.display="none";

};

}

function showAvatarPicker(uid){

avatarPicker.style.display="block";

document.querySelectorAll(".pick").forEach(img=>{

img.onclick=()=>{
update(ref(db,"users/"+uid),{
avatar:img.getAttribute("src")
});
avatarPicker.style.display="none";
};

});

}

function ensureProfile(uid){

onValue(ref(db,"users/"+uid),snap=>{

let u=snap.val()||{};

if(!u.username) askUsername(uid);
if(!u.avatar) showAvatarPicker(uid);

},{onlyOnce:true});

}

////////////////////////////////////////////////////////
// GPS
////////////////////////////////////////////////////////

function startGPS(uid){

navigator.geolocation.watchPosition(pos=>{

myLat=pos.coords.latitude;
myLng=pos.coords.longitude;

update(ref(db,"users/"+uid),{
lat:myLat,
lng:myLng,
status:"online"
});

map.setView([myLat,myLng],16);

});

}

////////////////////////////////////////////////////////
// CHAT SYSTEM
////////////////////////////////////////////////////////

let chatTarget=null;

function chatID(a,b){
return a<b ? a+"_"+b : b+"_"+a;
}

function openChat(uid,name){

chatTarget=uid;

chatTitle.innerText="Chat: "+name;
chatBox.style.display="block";

let id=chatID(myUID,uid);

onValue(ref(db,"chats/"+id),snap=>{

chatMessages.innerHTML="";

snap.forEach(m=>{

let msg=m.val();
chatMessages.innerHTML+=`
<div><b>${msg.from===myUID?"me":"them"}:</b>
${msg.text}</div>`;
});

chatMessages.scrollTop=9999;

});

}

sendBtn.onclick=()=>{

let text=chatInput.value.trim();
if(!text||!chatTarget) return;

push(ref(db,"chats/"+chatID(myUID,chatTarget)),{
from:myUID,
text:text,
time:Date.now()
});

chatInput.value="";

};

////////////////////////////////////////////////////////
// USER MENU
////////////////////////////////////////////////////////

let selectedUID=null;
let selectedName=null;

dmBtn.onclick=()=>{

userMenu.style.display="none";
openChat(selectedUID,selectedName);

};

////////////////////////////////////////////////////////
// RADAR
////////////////////////////////////////////////////////

onValue(ref(db,"users"),snap=>{

for(let id in markers){
map.removeLayer(markers[id]);
}
markers={};

snap.forEach(c=>{

let u=c.val();
if(!u.lat) return;

let icon=L.divIcon({
className:"",
html:`
<img src="${u.avatar||'avatar/avatar1.png'}"
style="width:50px;height:50px;border-radius:50%;">
<br>${u.username||"user"}
`
});

let marker=L.marker([u.lat,u.lng],{icon})
.addTo(map);

marker.on("click",()=>{

if(c.key===myUID) return;

selectedUID=c.key;
selectedName=u.username;

menuName.innerText=u.username;
userMenu.style.display="block";

});

markers[c.key]=marker;

});

});

////////////////////////////////////////////////////////
// AUTH
////////////////////////////////////////////////////////

onAuthStateChanged(auth,user=>{

if(user){

myUID=user.uid;

loginBox.innerHTML=`
Logged in: ${user.email}<br>
<button id="logout">Logout</button>
`;

logout.onclick=()=>{
update(ref(db,"users/"+myUID),{status:"offline"});
signOut(auth);
};

ensureProfile(myUID);
startGPS(myUID);

}else{

showLogin();

}

});

</script>

</body>
</html>
